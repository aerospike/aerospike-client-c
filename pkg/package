#!/bin/bash
# Package client.
# Mac OS X packages will be signed when the first argument is "-sign".
# Packages can only be signed by Aerospike.

signPackage="$1"  # "-sign" or empty string.

set -e

cd `dirname $0`

platform=`./platform`

if [ $? -ne 0 ]
then
  echo "Invalid platform."
  exit 1
fi

rev=`./version`

packageName=aerospike-client-c-$rev.$platform.x86_64

# Define directories
baseDir=`cd ..;pwd`
stageDir=$baseDir/stage
stageFinalDir=$stageDir/final/$packageName

if [ "$platform" = "mac" ]
then
	# Mac OS X does not have /usr, so use /usr/local instead.
	installDir=/usr/local

	# Remove .DS_Store files generated by Mac finder.
	find $baseDir -name ".DS_Store" -exec rm {} \;
else
	installDir=/usr
fi

# Make default package
echo Make default package
make -C $baseDir clean
make -C $baseDir all
make -C $baseDir docs

# Initialize stage dir
rm -rf $stageDir
mkdir -p $stageFinalDir

# Copy files
cp -p README.md $stageFinalDir
cp -p $baseDir/LICENSE.md $stageFinalDir

# Copy docs
mkdir -p $stageFinalDir/docs

if [ -d $baseDir/target/docs/html ]
then
  cp -pr $baseDir/target/docs/html/* $stageFinalDir/docs
else
  echo "ERROR: online docs not found."
  exit -1
fi

# Prepare benchmarks and examples
cp -pr $baseDir/benchmarks $stageFinalDir
make -C $stageFinalDir/benchmarks clean

cp -pr $baseDir/examples $stageFinalDir
make -C $stageFinalDir/examples clean
rm -rf $stageFinalDir/examples/scan_examples/foreground

# Modify Makefiles for external use.
for i in benchmarks/Makefile examples/project/Makefile
do
	awk 'BEGIN{OFS=""}
	{
		if (index($0,"AEROSPIKE") > 0)
		{
			idx = index($0,"$(AEROSPIKE)/target/$(PLATFORM)/lib/libaerospike.a")

			if (idx > 0)
			{
				str = $0
				sub(/\$\(AEROSPIKE\)\/target\/\$\(PLATFORM\)\/lib\/libaerospike.a/, "'$installDir'/lib/libaerospike.a", str)
				print str
			}
			else
			{
				print "CFLAGS += -I'$installDir'/include"
			}
		}
		else
		{
			print $0
		}
	}' $baseDir/$i > $stageFinalDir/$i
done

# Create library package for default synchronous library.
./package_type $signPackage lib sync $baseDir $stageDir $stageFinalDir

# Create devel package with library and header files.
./package_type $signPackage devel sync $baseDir $stageDir $stageFinalDir

# Package event library targets
for elib in libev libuv
do
	echo Make $elib package
	make -C $baseDir clean
	make EVENT_LIB=$elib -C $baseDir all

	./package_type $signPackage lib $elib $baseDir $stageDir $stageFinalDir
	./package_type $signPackage devel $elib $baseDir $stageDir $stageFinalDir
done

# Initialize package directory
packageDir=$baseDir/target/packages
rm -rf $packageDir
mkdir -p $packageDir

# Retain copies of all client packages for individual distribution
cp $stageDir/final/$packageName/aerospike-client-c-*-$rev.* $packageDir/

# Combine distribution into one final package.
tar cf - -C $stageDir/final $packageName | gzip -c > $packageDir/$packageName.tgz

# Create separate package of source code.
./package_src $baseDir $stageDir/SOURCE/aerospike-client-c
tar cfj $packageDir/aerospike-client-c-$rev.src.tar.bz2 -C $stageDir/SOURCE aerospike-client-c

# Cleanup temporary distribution.
rm -rf $stageDir
